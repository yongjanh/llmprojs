# ==============================================================================
# è¯´æ˜ï¼šæœ¬æ–‡ä»¶æ¼”ç¤º Agent çš„è®°å¿†ç®¡ç†æœºåˆ¶ (Memory Management)
# ==============================================================================
# åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒAgent å¾€å¾€éœ€è¦è¿›è¡Œé•¿æ—¶é—´ã€å¤šè½®æ¬¡çš„å¯¹è¯ã€‚
# éšç€å¯¹è¯è½®æ•°å¢åŠ ï¼Œä¸Šä¸‹æ–‡ä¼šå¿«é€Ÿè†¨èƒ€ï¼Œå¯¼è‡´ï¼š
# 1. Token æˆæœ¬æ¿€å¢
# 2. æ¨ç†å»¶è¿Ÿå˜é•¿
# 3. æ³¨æ„åŠ›åˆ†æ•£ï¼ˆæ¨¡å‹éš¾ä»¥èšç„¦å…³é”®ä¿¡æ¯ï¼‰
#
# ã€è§£å†³æ–¹æ¡ˆã€‘
# å¼•å…¥è®°å¿†ç®¡ç†ç­–ç•¥ï¼Œåœ¨"è®°å¿†å®Œæ•´æ€§"å’Œ"æ¨ç†æ•ˆç‡"ä¹‹é—´å–å¾—å¹³è¡¡ã€‚
#
# ã€æœ¬æ–‡ä»¶æ¼”ç¤ºå†…å®¹ã€‘
# 1. çŸ­æœŸè®°å¿† (InMemoryMemory)
#    - æœ€ç®€å•çš„ç¼“å†²åŒºï¼Œå­˜å‚¨æ‰€æœ‰å†å²å¯¹è¯
#    - é€‚ç”¨åœºæ™¯ï¼šçŸ­å¯¹è¯ã€å¼€å‘æµ‹è¯•
#
# 2. è®°å¿†æˆªæ–­ (Context Truncation)
#    - å›ºå®šçª—å£ç­–ç•¥ï¼Œè¶…å‡ºé™åˆ¶æ—¶ä»å¼€å¤´åˆ é™¤æ—§å¯¹è¯
#    - é€‚ç”¨åœºæ™¯ï¼šèŠå¤©æœºå™¨äººã€å®¢æœç³»ç»Ÿï¼ˆåªéœ€è®°ä½æœ€è¿‘å‡ è½®ï¼‰
#
# 3. æ»šåŠ¨æ‘˜è¦ (Rolling Summary)
#    - å®šæœŸå°†æ—§å¯¹è¯å‹ç¼©æˆæ‘˜è¦ï¼Œä¿ç•™å…³é”®ä¿¡æ¯
#    - é€‚ç”¨åœºæ™¯ï¼šé•¿æ–‡æœ¬åˆ›ä½œã€éœ€è¦ä¿ç•™å†å²è„‰ç»œçš„ä»»åŠ¡
#
# 4. å‘é‡åŒ–å¬å› (Vector-based Retrieval)
#    - å°†å¯¹è¯è½¬ä¸ºå‘é‡å­˜å‚¨ï¼ŒæŒ‰ç›¸ä¼¼åº¦æ£€ç´¢ç›¸å…³è®°å¿†
#    - é€‚ç”¨åœºæ™¯ï¼šçŸ¥è¯†åº“é—®ç­”ã€è·¨ä¼šè¯ä¿¡æ¯å…³è”
#
# ã€è®°å¿†ç®¡ç†çš„æƒè¡¡ã€‘
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ ç­–ç•¥        â”‚ å®Œæ•´æ€§    â”‚ æ•ˆç‡     â”‚ å®ç°å¤æ‚åº¦  â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ çŸ­æœŸè®°å¿†    â”‚ â­â­â­â­â­ â”‚ â­       â”‚ â­          â”‚
# â”‚ è®°å¿†æˆªæ–­    â”‚ â­â­      â”‚ â­â­â­â­  â”‚ â­â­        â”‚
# â”‚ æ»šåŠ¨æ‘˜è¦    â”‚ â­â­â­    â”‚ â­â­â­   â”‚ â­â­â­â­    â”‚
# â”‚ å‘é‡åŒ–å¬å›  â”‚ â­â­â­â­  â”‚ â­â­â­â­â­ â”‚ â­â­â­â­â­  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# ==============================================================================

import asyncio
import os
from textwrap import dedent

# AgentScope imports
from agentscope.agent import ReActAgent
from agentscope.memory import InMemoryMemory, Mem0LongTermMemory
from agentscope.message import Msg
from agentscope.formatter import DashScopeChatFormatter
from agentscope.embedding import DashScopeTextEmbedding
from agentscope.model import DashScopeChatModel
from agentscope.token import HuggingFaceTokenCounter
from mem0.vector_stores.configs import VectorStoreConfig

# Local imports
from config.load_key import load_key


# ==============================================================================
# è¾…åŠ©å‡½æ•°ï¼šåˆ›å»º Agent
# ==============================================================================

def create_agent(name: str, sys_prompt: str, **kwargs) -> ReActAgent:
    """
    åˆ›å»º Agent çš„è¾…åŠ©å‡½æ•°ï¼Œå…è®¸è°ƒç”¨æ–¹è¦†ç›–é»˜è®¤é…ç½®ã€‚
    
    Args:
        name: Agent åç§°
        sys_prompt: ç³»ç»Ÿæç¤ºè¯
        **kwargs: å¯é€‰å‚æ•°ï¼Œå¦‚ model, formatter, memory, long_term_memory ç­‰
    """
    # å…è®¸è°ƒç”¨æ–¹è¦†ç›–é»˜è®¤ model/formatter/memoryï¼Œé¿å…é‡å¤ç»‘å®š
    formatter = kwargs.pop("formatter", DashScopeChatFormatter())
    model = kwargs.pop(
        "model",
        DashScopeChatModel(
            model_name="qwen-plus",
            api_key=os.environ.get("DASHSCOPE_API_KEY"),
            stream=True,
        ),
    )
    memory = kwargs.pop("memory", InMemoryMemory())

    return ReActAgent(
        name=name,
        sys_prompt=sys_prompt,
        model=model,
        formatter=formatter,
        memory=memory,  # é»˜è®¤ä½¿ç”¨æœ€ç®€å•çš„å†…å­˜ç¼“å†²åŒº
        **kwargs,
    )


# ==============================================================================
# ç¤ºä¾‹ 1: çŸ­æœŸè®°å¿† (InMemoryMemory) - åŸºç¡€å¯¹è¯çŠ¶æ€ä¿æŒ
# ==============================================================================

async def demo_short_term_memory():
    """
    æ¼”ç¤ºçŸ­æœŸè®°å¿†çš„åŸºæœ¬å·¥ä½œæœºåˆ¶ã€‚
    
    ã€æ ¸å¿ƒæœºåˆ¶ã€‘
    InMemoryMemory æ˜¯æœ€ç®€å•çš„è®°å¿†æ¨¡å—ï¼Œå®ƒå°†æ‰€æœ‰å†å²å¯¹è¯å­˜å‚¨åœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­ã€‚
    æ¯æ¬¡è°ƒç”¨ Agent æ—¶ï¼Œä¼šè‡ªåŠ¨å°†å†å²è®°å½•å’Œæ–°æ¶ˆæ¯ä¸€èµ·å‘é€ç»™æ¨¡å‹ã€‚
    
    ã€é€‚ç”¨åœºæ™¯ã€‘
    - çŸ­å¯¹è¯ï¼ˆ< 10 è½®ï¼‰
    - å¼€å‘æµ‹è¯•
    - ä¸éœ€è¦è·¨ä¼šè¯è®°å¿†çš„ç®€å•ä»»åŠ¡
    """
    print("\n" + "="*60)
    print("  ç¤ºä¾‹ 1: çŸ­æœŸè®°å¿† (InMemoryMemory)")
    print("="*60 + "\n")
    
    # åˆ›å»ºä¸€ä¸ªè¯¾ç¨‹ç¼–å†™ Agent
    writing_agent = create_agent(
        name="Writer",
        sys_prompt="ä½ æ˜¯ä¸€ä¸ªè¯¾ç¨‹å†…å®¹ç¼–å†™å‘˜ã€‚ä½ çš„ä»»åŠ¡æ˜¯ç¼–å†™ä¸€ç¯‡ Pandas æ•°æ®åˆ†æè¯¾ç¨‹ã€‚"
    )
    
    # ç¬¬ä¸€æ¬¡å¯¹è¯ï¼šè®¾å®šæ•™å­¦é£æ ¼
    msg1 = Msg("user", "æˆ‘ä»¬çš„æ•™å­¦é£æ ¼è¦ä¸¥è°¨å…‹åˆ¶ï¼Œè¯·è®°ä½è¿™ä¸€ç‚¹ã€‚", "user")
    print(f"[{msg1.name}]: {msg1.content}")
    
    # Agent ä¼šå°†è¿™æ¬¡å¯¹è¯å­˜å…¥å®ƒçš„ InMemoryMemory
    reply1 = await writing_agent(msg1)
    print(f"[{reply1.name}]: {reply1.content}")

    print("\n" + "="*20 + "\n")

    # ç¬¬äºŒæ¬¡å¯¹è¯ï¼šåŸºäºä¹‹å‰çš„è®¾å®šæå‡ºæ–°è¦æ±‚
    # åœ¨è°ƒç”¨æ—¶ï¼Œwriting_agent ä¼šè‡ªåŠ¨å°† InMemoryMemory ä¸­çš„å†å²è®°å½•å’Œæ–°æ¶ˆæ¯ä¸€èµ·å‘ç»™æ¨¡å‹
    msg2 = Msg("user", "å¾ˆå¥½ï¼Œç°åœ¨è¯·æŠŠç¬¬äºŒéƒ¨åˆ†å†™å¾—æ›´ä¸“ä¸šä¸€äº›ã€‚", "user")
    print(f"[{msg2.name}]: {msg2.content}")
    
    reply2 = await writing_agent(msg2)
    print(f"[{reply2.name}]: {reply2.content}")
    
    print("\n" + "="*20 + "\n")
    print("Agent çš„çŸ­æœŸè®°å¿†å†…å®¹ï¼š")
    # æ‰“å° Agent çš„è®°å¿†ï¼Œå¯ä»¥çœ‹åˆ°åŒ…å«äº†å…¨éƒ¨ä¸¤è½®å¯¹è¯
    for m in await writing_agent.memory.get_memory():
        print(f"- [{m.role}] {m.name}: {m.content}")


# ==============================================================================
# ç¤ºä¾‹ 2: è®°å¿†æˆªæ–­ (Context Truncation) - å›ºå®šçª—å£ç­–ç•¥
# ==============================================================================

async def demo_truncation_strategy():
    """
    æ¼”ç¤ºåŸºäºå›ºå®šçª—å£çš„è®°å¿†æˆªæ–­ç­–ç•¥ã€‚
    
    ã€æ ¸å¿ƒæœºåˆ¶ã€‘
    é€šè¿‡ DashScopeChatFormatter çš„ max_tokens å‚æ•°é™åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦ã€‚
    å½“å†å²å¯¹è¯è¶…å‡ºé™åˆ¶æ—¶ï¼Œä¼šä»å¼€å¤´åˆ é™¤æ—§å¯¹è¯ï¼ˆFIFO ç­–ç•¥ï¼‰ã€‚
    
    ã€é€‚ç”¨åœºæ™¯ã€‘
    - èŠå¤©æœºå™¨äººï¼ˆåªéœ€è®°ä½æœ€è¿‘å‡ è½®ï¼‰
    - å®¢æœç³»ç»Ÿï¼ˆæ¯æ¬¡å¯¹è¯ç›¸å¯¹ç‹¬ç«‹ï¼‰
    - éœ€è¦ä¸¥æ ¼æ§åˆ¶æˆæœ¬å’Œå»¶è¿Ÿçš„åœºæ™¯
    
    ã€æ³¨æ„ã€‘
    æˆªæ–­å¯èƒ½å¯¼è‡´"é—å¿˜"æ—©æœŸçš„é‡è¦ä¿¡æ¯ï¼Œé€‚åˆä¸Šä¸‹æ–‡ä¾èµ–æ€§è¾ƒå¼±çš„ä»»åŠ¡ã€‚
    """
    print("\n" + "="*60)
    print("  ç¤ºä¾‹ 2: è®°å¿†æˆªæ–­ (Context Truncation)")
    print("="*60 + "\n")
    
    # åˆ›å»ºä¸€ä¸ªå¸¦æœ‰æˆªæ–­åŠŸèƒ½çš„ Formatterï¼ˆéœ€è¦æä¾› token è®¡æ•°å™¨ï¼Œå¦åˆ™ä¸ä¼šè§¦å‘æˆªæ–­ï¼‰
    token_counter = HuggingFaceTokenCounter(
        "Qwen/Qwen3-8B",
        use_mirror=True,
        use_fast=True,
        trust_remote_code=True,
    )
    truncated_formatter = DashScopeChatFormatter(
        token_counter=token_counter,
        max_tokens=40,
    )

    # åˆ›å»ºä¸€ä¸ªä½¿ç”¨è¯¥ Formatter çš„ Agent
    truncation_agent = create_agent(
        name="Trunk",
        sys_prompt="ä½ æ˜¯ä¸€ä¸ªå¥å¿˜çš„æœºå™¨äººï¼Œä½ åªèƒ½è®°ä½æœ€è¿‘å‘ç”Ÿçš„äº‹æƒ…ã€‚",
        # å°†é»˜è®¤çš„ formatter æ›¿æ¢ä¸ºæˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„å¸¦æˆªæ–­åŠŸèƒ½çš„ formatter
        formatter=truncated_formatter
    )
    
    # è¿›è¡Œå¤šè½®å¯¹è¯ï¼Œæ•…æ„è®©ä¸Šä¸‹æ–‡å˜é•¿
    await truncation_agent(Msg("user", "è§„åˆ™Aï¼šæ‰€æœ‰å›ç­”å¿…é¡»æ˜¯é™ˆè¿°å¥ã€‚", "user"))
    await truncation_agent(Msg("user", 'è§„åˆ™Bï¼šä¸èƒ½ä½¿ç”¨"ä½ "æˆ–"æˆ‘"ã€‚', "user"))
    await truncation_agent(Msg("user", "è§„åˆ™Cï¼šå›ç­”è¦å°½é‡ç®€çŸ­ã€‚", "user"))
    await truncation_agent(Msg("user", "è§„åˆ™Dï¼šæ•°å­—å¿…é¡»ç”¨å¤§å†™æ±‰å­—è¡¨ç¤ºã€‚", "user"))
    
    print("ç»è¿‡å¤šè½®å¯¹è¯åï¼ŒAgent çš„è®°å¿†ï¼ˆç†è®ºä¸Šå¾ˆé•¿ï¼‰ï¼š")
    for m in await truncation_agent.memory.get_memory():
        print(f"- [{m.role}] {m.name}: {m.content}")
        
    print("\n" + "="*20 + "\n")
    
    # æå‡ºä¸€ä¸ªé—®é¢˜ï¼Œæµ‹è¯• Agent æ˜¯å¦è¿˜è®°å¾—æœ€æ—©çš„è§„åˆ™ A
    reply = await truncation_agent(Msg("user", "è¯·æ€»ç»“ä¸€ä¸‹æ‰€æœ‰è§„åˆ™ã€‚", "user"))
    
    print(f"[{reply.name}]: {reply.content}")
    print('\nAgent å¾ˆå¯èƒ½å·²ç»å¿˜è®°äº†æœ€æ—©çš„"è§„åˆ™A"ï¼Œå› ä¸ºå®ƒä¸ºäº†æ»¡è¶³ max_tokens=40 çš„é™åˆ¶ï¼Œä»è®°å¿†çš„å¼€å¤´ä¸¢å¼ƒäº†æœ€æ—©çš„å¯¹è¯ã€‚')


# ==============================================================================
# ç¤ºä¾‹ 3: æ»šåŠ¨æ‘˜è¦ (Rolling Summary) - å‹ç¼©å†å²ä¿¡æ¯
# ==============================================================================

def demo_summary_strategy_concept():
    """
    æ¼”ç¤ºæ»šåŠ¨æ‘˜è¦ç­–ç•¥çš„æ ¸å¿ƒæ¦‚å¿µï¼ˆä¼ªä»£ç ç¤ºä¾‹ï¼‰ã€‚
    
    ã€æ ¸å¿ƒæœºåˆ¶ã€‘
    å®šæœŸå°†æ—§å¯¹è¯å‹ç¼©æˆä¸€æ®µæ‘˜è¦æ–‡æœ¬ï¼Œç”¨æ‘˜è¦æ›¿æ¢åŸå§‹å¯¹è¯ã€‚
    è¿™æ ·æ—¢ä¿ç•™äº†å†å²è„‰ç»œï¼Œåˆæ§åˆ¶äº†ä¸Šä¸‹æ–‡é•¿åº¦ã€‚
    
    ã€å®ç°æ­¥éª¤ã€‘
    1. å½“å†å²å¯¹è¯è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œé€‰å–å‰ N% çš„å¯¹è¯
    2. è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆè¿™äº›å¯¹è¯çš„æ‘˜è¦
    3. ç”¨æ‘˜è¦æ¶ˆæ¯æ›¿æ¢åŸå§‹å¯¹è¯
    4. ä¿ç•™å‰©ä½™å¯¹è¯ + æ‘˜è¦
    
    ã€é€‚ç”¨åœºæ™¯ã€‘
    - é•¿æ–‡æœ¬åˆ›ä½œï¼ˆéœ€è¦è®°ä½æ•…äº‹çº¿ç´¢ï¼‰
    - é¡¹ç›®ç®¡ç†å¯¹è¯ï¼ˆéœ€è¦è¿½è¸ªå†å²å†³ç­–ï¼‰
    - éœ€è¦ä¿ç•™ä¸Šä¸‹æ–‡è¿è´¯æ€§çš„ä»»åŠ¡
    
    ã€æ³¨æ„ã€‘
    è¿™æ˜¯ä¸€ä¸ªä¼ªä»£ç ç¤ºä¾‹ï¼Œç”¨äºæ¼”ç¤ºæ»šåŠ¨æ‘˜è¦çš„æ ¸å¿ƒé€»è¾‘ã€‚
    å®ƒä¸èƒ½ç›´æ¥è¿è¡Œï¼Œéœ€è¦ä½ ç»§æ‰¿ agentscope.memory.MemoryBase å¹¶å®ç°å®Œæ•´é€»è¾‘ã€‚
    """
    print("\n" + "="*60)
    print("  ç¤ºä¾‹ 3: æ»šåŠ¨æ‘˜è¦ (Rolling Summary) - æ¦‚å¿µæ¼”ç¤º")
    print("="*60 + "\n")
    
    print("è¿™æ˜¯ä¸€ä¸ªä¼ªä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºæ»šåŠ¨æ‘˜è¦çš„æ ¸å¿ƒé€»è¾‘ï¼š")
    print("-" * 60)
    
    class SummaryMemory:  # (MemoryBase)
        def __init__(self, buffer_size=10, summary_ratio=0.5):
            self.history = []
            self.buffer_size = buffer_size
            self.summary_ratio = summary_ratio

        def add(self, message):
            self.history.append(message)
            self.try_summarize()

        def try_summarize(self):
            if len(self.history) > self.buffer_size:
                # 1. ç¡®å®šè¦æ‘˜è¦çš„éƒ¨åˆ†
                num_to_summarize = int(len(self.history) * self.summary_ratio)
                messages_to_summarize = self.history[:num_to_summarize]
                
                # 2. è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆæ‘˜è¦ (ä¼ªä»£ç )
                # summary_text = llm.call("è¯·å°†ä»¥ä¸‹å¯¹è¯æ€»ç»“ä¸ºä¸€æ®µè¯ï¼š", messages_to_summarize)
                summary_text = "ç”¨æˆ·è®¾å®šäº†æ•™å­¦é£æ ¼ä¸ºé£è¶£å¹½é»˜ï¼Œå¹¶è¦æ±‚å†…å®¹ç”ŸåŠ¨ã€‚"
                
                summary_message = Msg("system", f"ã€å†å²æ‘˜è¦ã€‘{summary_text}", "system")
                
                # 3. ç”¨æ‘˜è¦æ›¿æ¢åŸå§‹å¯¹è¯
                self.history = [summary_message] + self.history[num_to_summarize:]
                print(f"--- è®°å¿†å·²å‹ç¼©ï¼Œå½“å‰é•¿åº¦ {len(self.history)} ---")
                
        def get_memory(self):
            return self.history

    # ä½¿ç”¨ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼‰
    # summary_mem = SummaryMemory()
    # summary_mem.add(Msg("user", "æˆ‘ä»¬çš„æ•™å­¦é£æ ¼è¦é£è¶£å¹½é»˜ã€‚", "user"))
    # ... ç»è¿‡å¤šè½®å¯¹è¯å ...
    # summary_mem.add(Msg("user", "å†å¢åŠ ä¸€ä¸ªå…³äºæˆæœ¬çš„æ¡ˆä¾‹ã€‚", "user"))  # æ­¤æ—¶å¯èƒ½ä¼šè§¦å‘æ‘˜è¦
    
    print("\nğŸ’¡ å…³é”®æ€æƒ³ï¼š")
    print("  - ä¸æ˜¯ç®€å•ä¸¢å¼ƒæ—§ä¿¡æ¯ï¼Œè€Œæ˜¯å‹ç¼©ä¿ç•™å…³é”®å†…å®¹")
    print("  - éœ€è¦é¢å¤–çš„ LLM è°ƒç”¨æ¥ç”Ÿæˆæ‘˜è¦ï¼ˆå¢åŠ æˆæœ¬ï¼‰")
    print("  - é€‚åˆéœ€è¦é•¿æœŸä¸Šä¸‹æ–‡è¿è´¯æ€§çš„åœºæ™¯")


# ==============================================================================
# ç¤ºä¾‹ 4: å‘é‡åŒ–å¬å› (Vector-based Retrieval) - æ™ºèƒ½è®°å¿†æ£€ç´¢
# ==============================================================================

async def demo_vector_based_retrieval():
    """
    æ¼”ç¤ºåŸºäºå‘é‡ç›¸ä¼¼åº¦çš„é•¿æœŸè®°å¿†ç®¡ç†ã€‚
    
    ã€æ ¸å¿ƒæœºåˆ¶ã€‘
    1. å­˜å‚¨ (Ingestion)ï¼šå°†å¯¹è¯è½¬æ¢æˆå‘é‡ (Embedding)ï¼Œå­˜å…¥å‘é‡æ•°æ®åº“
    2. æ£€ç´¢ (Retrieval)ï¼šå°†æ–°é—®é¢˜è½¬ä¸ºå‘é‡ï¼ŒæŒ‰ç›¸ä¼¼åº¦æ£€ç´¢ç›¸å…³å†å²è®°å¿†
    3. ç»„åˆ (Composition)ï¼šå°†æ£€ç´¢ç»“æœ + æ–°é—®é¢˜ç»„åˆæˆä¸Šä¸‹æ–‡å‘ç»™æ¨¡å‹
    
    ã€ä¸¤ç§æ§åˆ¶æ¨¡å¼çš„æœ¬è´¨åŒºåˆ«ã€‘
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç»´åº¦             â”‚ static_control        â”‚ agent_control         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ è§¦å‘æ–¹å¼         â”‚ æ¡†æ¶è‡ªåŠ¨ï¼ˆæ¯è½®å¯¹è¯ï¼‰  â”‚ Agent ä¸»åŠ¨è°ƒç”¨å·¥å…·    â”‚
    â”‚ å­˜å‚¨ç­–ç•¥         â”‚ è‡ªåŠ¨å­˜å‚¨æ‰€æœ‰å¯¹è¯      â”‚ Agent é€‰æ‹©æ€§å­˜å‚¨      â”‚
    â”‚ æ£€ç´¢ç­–ç•¥         â”‚ è‡ªåŠ¨æ£€ç´¢ç›¸å…³è®°å¿†      â”‚ Agent åˆ¤æ–­æ˜¯å¦æ£€ç´¢    â”‚
    â”‚ Agent æ„ŸçŸ¥       â”‚ æ— æ„ŸçŸ¥ï¼ˆé€æ˜ï¼‰        â”‚ æœ‰æ„ŸçŸ¥ï¼ˆå¯æ§ï¼‰        â”‚
    â”‚ æ§åˆ¶ç²’åº¦         â”‚ ç²—ç²’åº¦ï¼ˆå…¨å±€å¼€å…³ï¼‰    â”‚ ç»†ç²’åº¦ï¼ˆå•æ¬¡å†³ç­–ï¼‰    â”‚
    â”‚ é€‚ç”¨åœºæ™¯         â”‚ ç®€å•åœºæ™¯ã€å¿«é€Ÿé›†æˆ    â”‚ å¤æ‚ç­–ç•¥ã€ç²¾å‡†æ§åˆ¶    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    âš ï¸ å¸¸è§è¯¯è§£æ¾„æ¸…:
    - static_control â‰  "æ‰€æœ‰ä¿¡æ¯æ°¸ä¹…ä¿å­˜"
      â†’ å‘é‡æ•°æ®åº“å†…éƒ¨å¯èƒ½æœ‰è‡ªå·±çš„æ¸…ç†ç­–ç•¥ï¼ˆå¦‚å®¹é‡é™åˆ¶ã€æ—¶é—´è¡°å‡ï¼‰
      â†’ å­˜å‚¨çš„æ˜¯å¯¹è¯å†…å®¹ï¼Œä½†åº•å±‚å­˜å‚¨å¼•æ“å¯èƒ½ä¼šç®¡ç†å®¹é‡
    
    - agent_control â‰  "çµæ´»ä¸¢å¼ƒ"
      â†’ ä¸æ˜¯"ä¸¢å¼ƒ"ï¼Œè€Œæ˜¯"é€‰æ‹©æ€§è®°å½•"
      â†’ Agent åªè®°å½•å®ƒè®¤ä¸ºé‡è¦çš„ä¿¡æ¯ï¼ˆå¦‚æ ¸å¿ƒè¦æ±‚ã€å…³é”®å†³ç­–ï¼‰
      â†’ æ›´åƒæ˜¯"ä¸»åŠ¨åšç¬”è®°"è€Œé"è¢«åŠ¨å½•éŸ³"
    
    ã€é€‚ç”¨åœºæ™¯ã€‘
    - çŸ¥è¯†åº“é—®ç­”ï¼ˆéœ€è¦è·¨ä¼šè¯ä¿¡æ¯å…³è”ï¼‰
    - ä¸ªæ€§åŒ–å¯¹è¯ï¼ˆéœ€è¦è®°ä½ç”¨æˆ·åå¥½ï¼‰
    - é•¿æœŸé¡¹ç›®åä½œï¼ˆéœ€è¦è¿½æº¯å†å²å†³ç­–ï¼‰
    """
    print("\n" + "="*60)
    print("  ç¤ºä¾‹ 4: å‘é‡åŒ–å¬å› (Vector-based Retrieval)")
    print("="*60 + "\n")
    
    # 1. åˆå§‹åŒ–é•¿æœŸè®°å¿†æ¨¡å—
    # å®ƒéœ€è¦ä¸€ä¸ªè¯­è¨€æ¨¡å‹ï¼ˆç”¨äºå†…éƒ¨å¤„ç†ï¼‰å’Œä¸€ä¸ªåµŒå…¥æ¨¡å‹
    # ä¸º Qdrant æœ¬åœ°å‘é‡åº“æŒ‡å®šä¸ DashScope Embedding ä¸€è‡´çš„ç»´åº¦ï¼ˆ2048ï¼‰
    vector_store = VectorStoreConfig(
        config={
            "on_disk": False,
            "embedding_model_dims": 2048,
        }
    )

    long_term_memory = Mem0LongTermMemory(
        agent_name="Writer",
        user_name="user",
        model=DashScopeChatModel(
            model_name="qwen-plus",
            api_key=os.environ.get("DASHSCOPE_API_KEY"),
            stream=False,
        ),
        embedding_model=DashScopeTextEmbedding(
            model_name="text-embedding-v4",
            api_key=os.environ.get("DASHSCOPE_API_KEY"),
            dimensions=2048
        ),
        vector_store_config=vector_store,
    )

    # 2. æ¼”ç¤º static_control æ¨¡å¼ï¼ˆè¢«åŠ¨è®°å¿†ç®¡ç†ï¼‰
    print("--- æ¨¡å¼ A: static_control (è¢«åŠ¨è®°å¿†ç®¡ç†) ---\n")
    
    ltm_agent_static = create_agent(
        name="LTM_Writer_Static",
        sys_prompt="ä½ æ˜¯ä¸€ä¸ªæ‹¥æœ‰é•¿æœŸè®°å¿†çš„è¯¾ç¨‹ç¼–å†™å‘˜ã€‚",
        long_term_memory=long_term_memory,
        long_term_memory_mode="static_control",  # å…³é”®å‚æ•°ï¼šè®¾ç½®ä¸ºé™æ€æ§åˆ¶æ¨¡å¼
    )
    
    # å¯¹è¯ä¸€ï¼šå­˜å…¥ä¸€ä¸ªå…³é”®ä¿¡æ¯
    msg1 = Msg("user", "è®°ä½ï¼Œæˆ‘ä»¬æ­£åœ¨å†™ä¸€ç¯‡ Pandas æ•°æ®åˆ†æè¯¾ç¨‹ï¼Œç›®å‰å·²ç»å†™å®Œåˆç¨¿ã€‚", "user")
    print(f"[{msg1.name}]: {msg1.content}")
    reply1 = await ltm_agent_static(msg1)
    print(f"[{reply1.name}]: {reply1.content}")
    # åœ¨è¿™ä¸€æ­¥ä¹‹åï¼Œå¯¹è¯å†…å®¹ä¼šè¢«è‡ªåŠ¨å­˜å…¥é•¿æœŸè®°å¿†

    print("\n" + "="*20 + " æ¨¡æ‹Ÿæ–°çš„ä¸€æ¬¡ä¼šè¯ " + "="*20 + "\n")

    # æ¸…ç©º Agent çš„çŸ­æœŸè®°å¿†ï¼Œæ¨¡æ‹Ÿä¸€æ¬¡å…¨æ–°çš„ä¼šè¯
    await ltm_agent_static.memory.clear()
    print("Agent çš„çŸ­æœŸè®°å¿†å·²è¢«æ¸…ç©ºã€‚\n")

    # å¯¹è¯äºŒï¼šæå‡ºä¸€ä¸ªç›¸å…³é—®é¢˜
    # Agent åœ¨å›å¤å‰ï¼Œä¼šç”¨é—®é¢˜å»é•¿æœŸè®°å¿†ä¸­æ£€ç´¢
    msg2 = Msg("user", "æˆ‘ä»¬ä¸Šæ¬¡çš„å·¥ä½œè¿›åº¦åˆ°å“ªå„¿äº†ï¼Ÿ", "user")
    print(f"[{msg2.name}]: {msg2.content}")
    reply2 = await ltm_agent_static(msg2)
    print(f"[{reply2.name}]: {reply2.content}")
    print("\nğŸ’¡ æ³¨æ„: å³ä½¿çŸ­æœŸè®°å¿†è¢«æ¸…ç©ºï¼ŒAgent ä¾ç„¶èƒ½å›ç­”æ­£ç¡®ï¼Œå› ä¸ºå®ƒä»é•¿æœŸè®°å¿†ä¸­æ£€ç´¢åˆ°äº†ç›¸å…³ä¿¡æ¯ã€‚")
    
    # 3. æ¼”ç¤º agent_control æ¨¡å¼ï¼ˆä¸»åŠ¨è®°å¿†ç®¡ç†ï¼‰
    print("\n\n--- æ¨¡å¼ B: agent_control (ä¸»åŠ¨è®°å¿†ç®¡ç†) ---\n")
    
    ltm_agent_active = create_agent(
        name="LTM_Writer_Active",
        sys_prompt=dedent(
            "ä½ æ˜¯ä¸€ä¸ªæ‹¥æœ‰ä¸»åŠ¨è®°å¿†ç®¡ç†èƒ½åŠ›çš„è¯¾ç¨‹ç¼–å†™å‘˜ã€‚\n"
            "ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·æ¥ç®¡ç†ä½ çš„é•¿æœŸè®°å¿†ï¼š\n"
            "- `record_to_memory(data: str)`: å°†ä¸€æ®µé‡è¦çš„ä¿¡æ¯è®°å½•åˆ°é•¿æœŸè®°å¿†ä¸­ã€‚\n"
            "- `retrieve_from_memory(query: str) -> str`: æ ¹æ®æŸ¥è¯¢ä»é•¿æœŸè®°å¿†ä¸­æ£€ç´¢ç›¸å…³ä¿¡æ¯ã€‚\n"
            "åœ¨å›ç­”é—®é¢˜å‰ï¼Œå…ˆæ€è€ƒæ˜¯å¦éœ€è¦æ£€ç´¢è®°å¿†ã€‚åœ¨å¯¹è¯ç»“æŸåï¼Œæ€è€ƒæ˜¯å¦æœ‰å…³é”®ä¿¡æ¯éœ€è¦è®°å½•ã€‚"
        ),
        long_term_memory=long_term_memory,
        long_term_memory_mode="agent_control",  # å…³é”®å‚æ•°ï¼šè®¾ç½®ä¸º Agent æ§åˆ¶æ¨¡å¼
    )
    
    # å¯¹è¯ä¸€ï¼šAgent è‡ªä¸»å†³å®šè®°å½•ä¿¡æ¯
    msg1 = Msg("user", "è¯¾ç¨‹çš„å†™ä½œé£æ ¼å¿…é¡»éå¸¸ä¸¥è°¨å’Œå­¦æœ¯åŒ–ï¼Œè¿™æ˜¯ä¸€ä¸ªæ ¸å¿ƒè¦æ±‚ã€‚", "user")
    print(f"[{msg1.name}]: {msg1.content}")
    reply1 = await ltm_agent_active(msg1)
    # Agent åœ¨è¿™é‡Œçš„æ€è€ƒè¿‡ç¨‹ä¸­ï¼Œä¼šåˆ¤æ–­"æ ¸å¿ƒè¦æ±‚"æ˜¯é‡è¦ä¿¡æ¯ï¼Œå¹¶è°ƒç”¨ record_to_memory å·¥å…·
    print(f"[{reply1.name}]: {reply1.content}")
    
    print("\n" + "="*20 + " æ¨¡æ‹Ÿä¸€æ¬¡æ–°çš„ä¼šè¯ " + "="*20 + "\n")
    await ltm_agent_active.memory.clear()

    # å¯¹è¯äºŒï¼šAgent è‡ªä¸»å†³å®šæ£€ç´¢ä¿¡æ¯
    msg2 = Msg("user", "æˆ‘å¿˜äº†ï¼Œæˆ‘ä»¬è¯¾ç¨‹çš„å†™ä½œé£æ ¼æ˜¯ä»€ä¹ˆæ¥ç€ï¼Ÿ", "user")
    print(f"[{msg2.name}]: {msg2.content}")
    reply2 = await ltm_agent_active(msg2)
    # Agent åœ¨è¿™é‡Œçš„æ€è€ƒè¿‡ç¨‹ä¸­ï¼Œä¼šå…ˆè°ƒç”¨ retrieve_from_memory(query="å†™ä½œé£æ ¼")ï¼Œå†æ ¹æ®æ£€ç´¢ç»“æœç”Ÿæˆå›ç­”
    print(f"[{reply2.name}]: {reply2.content}")
    
    print("\nğŸ’¡ å…³é”®åŒºåˆ«:")
    print("  - static_control: æ¡†æ¶è‡ªåŠ¨ç®¡ç†ï¼ŒAgent æ— æ„ŸçŸ¥ï¼ˆé€‚åˆç®€å•åœºæ™¯ï¼‰")
    print("  - agent_control: Agent ä¸»åŠ¨å†³ç­–ï¼Œæ›´çµæ´»ä½†éœ€è¦æ¨¡å‹å…·å¤‡å·¥å…·è°ƒç”¨èƒ½åŠ›")


# ==============================================================================
# ä¸»ç¨‹åºå…¥å£
# ==============================================================================

async def main():
    """ä¸»ç¨‹åºï¼šä¾æ¬¡è¿è¡Œå„ä¸ªè®°å¿†ç®¡ç†ç­–ç•¥çš„æ¼”ç¤ºã€‚"""
    load_key()
    print("\nç¯å¢ƒé…ç½®å®Œæˆï¼")
    
    # ç¤ºä¾‹ 1ï¼šçŸ­æœŸè®°å¿†
    try:
        await demo_short_term_memory()
    except Exception as e:
        print(f"ç¤ºä¾‹ 1 è¿è¡Œå‡ºé”™: {e}")
    
    # ç¤ºä¾‹ 2ï¼šè®°å¿†æˆªæ–­
    try:
        await demo_truncation_strategy()
    except Exception as e:
        print(f"ç¤ºä¾‹ 2 è¿è¡Œå‡ºé”™: {e}")
    
    # ç¤ºä¾‹ 3ï¼šæ»šåŠ¨æ‘˜è¦ï¼ˆæ¦‚å¿µæ¼”ç¤ºï¼Œéå¯æ‰§è¡Œï¼‰
    try:
        demo_summary_strategy_concept()
    except Exception as e:
        print(f"ç¤ºä¾‹ 3 è¿è¡Œå‡ºé”™: {e}")
    
    # ç¤ºä¾‹ 4ï¼šå‘é‡åŒ–å¬å›
    try:
        await demo_vector_based_retrieval()
    except Exception as e:
        print(f"ç¤ºä¾‹ 4 è¿è¡Œå‡ºé”™: {e}")


if __name__ == "__main__":
    asyncio.run(main())
