# ==============================================================================
# è¯´æ˜ï¼šæœ¬æ–‡ä»¶æ¶‰åŠ Meta Prompting çš„è¿›é˜¶åº”ç”¨ â€”â€” åŸºäº AI åˆ¤åˆ«å™¨ (Judge) çš„è‡ªåŠ¨åŒ–ä¼˜åŒ–
# ==============================================================================
# è¿™æ˜¯ Meta Prompting çš„å·¥ç¨‹åŒ–å‡çº§ç‰ˆæœ¬ï¼Œå¼•å…¥äº† DSPy çš„æ ¸å¿ƒæ€æƒ³ã€‚
#
# ã€æ ¸å¿ƒç—›ç‚¹ã€‘
# ä¼ ç»Ÿçš„ Meta Prompting (å¦‚ 3_prompt_1_metaprompt.py) ä¾èµ–äºå•æ¬¡è¿­ä»£å’Œä¸»è§‚åˆ¤æ–­ï¼Œ
# å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
# 1. ä¸ç¨³å®šï¼šæ¯æ¬¡è¿è¡Œç»“æœå·®å¼‚å¤§
# 2. ä¸å¯æ§ï¼šæ²¡æœ‰æ˜ç¡®çš„è¯„åˆ¤æ ‡å‡†
# 3. éš¾ä»¥æ”¶æ•›ï¼šç¼ºä¹æ•°æ®é©±åŠ¨çš„åé¦ˆæœºåˆ¶
#
# ã€è§£å†³æ–¹æ¡ˆï¼šDSPy æ€æƒ³ã€‘
# å€Ÿé‰´ DSPy (Declarative Self-improving Python) çš„å·¥ç¨‹åŒ–æ€è·¯ï¼š
# "ç”¨æ•°æ®æ ¡å‡†è£åˆ¤ï¼Œç”¨è£åˆ¤ä¼˜åŒ–ç”Ÿæˆå™¨"
#
# ã€æ ¸å¿ƒæµç¨‹ã€‘
# é˜¶æ®µ 1ï¼šè®­ç»ƒè£åˆ¤ (Train the Judge)
#   1. å‡†å¤‡æ ‡æ³¨æ•°æ®é›†ï¼ˆGolden Datasetï¼‰ï¼šå¥½å›ç­” vs åå›ç­”
#   2. åˆå§‹åŒ–è£åˆ¤æç¤ºè¯
#   3. åœ¨è®­ç»ƒé›†ä¸Šè¯„ä¼°å‡†ç¡®ç‡
#   4. é’ˆå¯¹é”™åˆ¤çš„æ¡ˆä¾‹ä¼˜åŒ–è£åˆ¤æç¤ºè¯
#   5. è¿­ä»£ç›´åˆ°è£åˆ¤è¶³å¤Ÿå…¬æ­£
#
# é˜¶æ®µ 2ï¼šä¼˜åŒ–ç”Ÿæˆå™¨ (Optimize the Generator)
#   1. ç”Ÿæˆå™¨ç”Ÿæˆå›ç­”
#   2. è®­ç»ƒå¥½çš„è£åˆ¤è¿›è¡Œå®¡æ ¸
#   3. å¦‚æœä¸é€šè¿‡ï¼Œä¼˜åŒ–å™¨å‚è€ƒ"è£åˆ¤è§„åˆ™ä¹¦"æ”¹è¿›ç”Ÿæˆæç¤ºè¯
#   4. è¿­ä»£ç›´åˆ°é€šè¿‡å®¡æ ¸
#
# ã€å…³é”®ä¼˜åŠ¿ã€‘
# âœ“ æ•°æ®é©±åŠ¨ï¼šé€šè¿‡æ ‡æ³¨æ•°æ®å®šä¹‰"å¥½å"æ ‡å‡†
# âœ“ å¯é‡åŒ–ï¼šå‡†ç¡®ç‡ä½œä¸ºæ˜ç¡®çš„è¯„ä¼°æŒ‡æ ‡
# âœ“ å¯è¿­ä»£ï¼šè‡ªåŠ¨åŒ–çš„ä¼˜åŒ–é—­ç¯
#
# ã€ä¸åŸºç¡€ç‰ˆ (3_prompt_1) çš„å¯¹æ¯”ã€‘
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ ç»´åº¦            â”‚ åŸºç¡€ç‰ˆ (3_prompt_1) â”‚ è¿›é˜¶ç‰ˆ (æœ¬æ–‡ä»¶)     â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ è¯„åˆ¤æ ‡å‡†        â”‚ ä¸»è§‚ï¼ˆå‚è€ƒç­”æ¡ˆï¼‰    â”‚ å®¢è§‚ï¼ˆæ ‡æ³¨æ•°æ®é›†ï¼‰  â”‚
# â”‚ è£åˆ¤è´¨é‡        â”‚ ä¸€æ¬¡æ€§ç”Ÿæˆ          â”‚ æ•°æ®é©±åŠ¨è®­ç»ƒ        â”‚
# â”‚ ä¼˜åŒ–è·¯å¾„        â”‚ å·®è·åˆ†æ            â”‚ è£åˆ¤è§„åˆ™ä¹¦é©±åŠ¨      â”‚
# â”‚ å¯é‡ç°æ€§        â”‚ ä½                  â”‚ é«˜                  â”‚
# â”‚ å·¥ç¨‹åŒ–ç¨‹åº¦      â”‚ å®éªŒæ€§              â”‚ æ¥è¿‘ç”Ÿäº§çº§          â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ã€é€‚ç”¨åœºæ™¯ã€‘
# âœ“ éœ€è¦æ˜ç¡®è´¨é‡æ ‡å‡†çš„ä»»åŠ¡ï¼ˆå®¢æœå¯¹è¯ã€æ–‡æ¡£ç”Ÿæˆï¼‰
# âœ“ æœ‰æ ‡æ³¨æ•°æ®å¯ç”¨çš„åœºæ™¯
# âœ“ éœ€è¦å¯é‡åŒ–ã€å¯å¤ç°çš„ä¼˜åŒ–æµç¨‹
# ==============================================================================

from chatbot import llm
from config.load_key import load_key


# ==============================================================================
# å…¨å±€é…ç½®ï¼šæ ‡æ³¨æ•°æ®é›†
# ==============================================================================

# å‡†å¤‡ä¸€æ‰¹é«˜è´¨é‡çš„æ ‡æ³¨æ ·æœ¬
# åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™äº›æ ·æœ¬å¯ä»¥ä¸Šä¼ åˆ° AI å¹³å°ï¼ˆå¦‚ç™¾ç‚¼ï¼‰åˆ›å»ºè¯„ä¼°é›†
LABELED_SAMPLES = [
    # --- 3ä¸ªæ ·æœ¬ç”¨äº"è®­ç»ƒ" ---
    {
        "id": "train_01",
        "response": "å…¬å¸ç¦åˆ©ï¼šå¥åº·ä¿é™©ï¼Œå®¶å±å¯ç”¨ã€‚15å¤©å¹´å‡ï¼Œ5å¤©ç—…å‡ã€‚äº¤é€šè¡¥è´´500ï¼Œé¤é¥®è¡¥è´´300ã€‚åŸ¹è®­åŸºé‡‘8000ã€‚å¥èº«æˆ¿æœ‰æŠ˜æ‰£ã€‚", 
        "label": "ä¸é€šè¿‡", 
        "reason": "ä¿¡æ¯ç½—åˆ—ï¼Œæ— ç»“æ„ï¼Œæ— å‹å¥½è¯­æ°”"
    },
    {
        "id": "train_02",
        "response": """å…¬å¸ç¦åˆ©åŒ…æ‹¬ï¼š
1. å¥åº·å’Œå‡æœŸï¼šå¥åº·ä¿é™©ã€å¹´åº¦ä½“æ£€ã€15å¤©å¹´å‡å’Œ5å¤©ç—…å‡ã€‚
2. è¡¥è´´å’Œæ¿€åŠ±ï¼šæ¯æœˆ500äº¤é€šè¡¥è´´å’Œ300é¤é¥®è¡¥è´´ï¼Œä»¥åŠ8000å…ƒçš„åŸ¹è®­åŸºé‡‘ã€‚""",
        "label": "ä¸é€šè¿‡", 
        "reason": "æœ‰ç»“æ„ä½†è¯­æ°”å¹³æ·¡ï¼Œç¼ºä¹æ¬¢è¿æ„Ÿ"
    },
    {
        "id": "train_03",
        "response": """ğŸ‘‹ æ¬¢è¿åŠ å…¥ï¼æˆ‘ä»¬ä¸ºä½ å‡†å¤‡äº†è¶…æ£’çš„ç¦åˆ©ï¼š
- ğŸ¥ å…¨é¢å¥åº·ä¿é™©å’Œå¹´åº¦ä½“æ£€
- ğŸŒ´ 15å¤©å¹´å‡+5å¤©ç—…å‡
- ğŸ’° æ¯æœˆäº¤é€šå’Œé¤é¥®è¡¥è´´
- ğŸ“ é«˜è¾¾8000å…ƒçš„åŸ¹è®­åŸºé‡‘
æœŸå¾…ä¸ä½ å…±äº‹ï¼ğŸ‰""",
        "label": "é€šè¿‡", 
        "reason": "ç»“æ„æ¸…æ™°ã€è¯­æ°”å‹å¥½ã€è§†è§‰å¸å¼•åŠ›å¼º"
    },
    
    # --- 2ä¸ªæ ·æœ¬ç”¨äº"è¯„ä¼°" ---
    {
        "id": "eval_01",
        "response": "æˆ‘ä»¬æœ‰å¥åº·ä¿é™©ã€å¹´å‡ã€ç—…å‡ã€äº¤é€šå’Œé¤é¥®è¡¥è´´ã€åŸ¹è®­åŸºé‡‘å’Œå¥èº«æŠ˜æ‰£ã€‚", 
        "label": "ä¸é€šè¿‡", 
        "reason": "ç®€å•ç½—åˆ—ï¼Œæ— ç»“æ„ï¼Œæ— æ¬¢è¿è¯­æ°”"
    },
    {
        "id": "eval_02",
        "response": """ä½ å¥½ï¼Œæ–°åŒäº‹ï¼å…¬å¸ç¦åˆ©å¾ˆæ£’å“¦ï¼š
- å¥åº·æ–¹é¢æœ‰ä¿é™©å’Œä½“æ£€ã€‚
- å‡æœŸæœ‰å¹´å‡å’Œç—…å‡ã€‚
- é’±çš„æ–¹é¢æœ‰è¡¥è´´å’Œæ•™è‚²åŸºé‡‘ã€‚
ç¥ä½ å·¥ä½œæ„‰å¿«ï¼""",
        "label": "é€šè¿‡", 
        "reason": "å‹å¥½è¯­æ°”ã€åŸºæœ¬ç»“æ„ã€æ¬¢è¿æ„Ÿ"
    },
]

# æ¨¡æ‹Ÿ RAG æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡
RETRIEVED_TEXT = """
å…³äºå…¬å¸çš„ç¦åˆ©æ”¿ç­–ï¼Œæˆ‘ä»¬æä¾›å…¨é¢çš„å¥åº·ä¿é™©ï¼Œè¦†ç›–å‘˜å·¥åŠå…¶ç›´ç³»å®¶å±ã€‚
å¹´åº¦ä½“æ£€æ˜¯æ ‡é…ã€‚æ­¤å¤–ï¼Œæ¯å¹´æœ‰15å¤©çš„å¸¦è–ªå¹´å‡ï¼Œä»¥åŠ5å¤©çš„å¸¦è–ªç—…å‡ã€‚
æˆ‘ä»¬è¿˜æä¾›æ¯æœˆ500å…ƒçš„äº¤é€šè¡¥è´´å’Œ300å…ƒçš„é¤é¥®è¡¥è´´ã€‚
ä¸ºäº†é¼“åŠ±å‘˜å·¥æˆé•¿ï¼Œå…¬å¸è®¾æœ‰æ¯å¹´é«˜è¾¾8000å…ƒçš„æ•™è‚²åŸ¹è®­åŸºé‡‘ï¼Œå‘˜å·¥å¯ä»¥ç”³è¯·ç”¨äºè¯¾ç¨‹å­¦ä¹ æˆ–è´­ä¹°ä¸“ä¸šä¹¦ç±ã€‚
å¥èº«æ–¹é¢ï¼Œå…¬å¸ä¸å¤šå®¶å¥èº«æˆ¿æœ‰åˆä½œï¼Œå‘˜å·¥å¯äº«å—æŠ˜æ‰£ä»·ã€‚
"""


# ==============================================================================
# è¾…åŠ©å‡½æ•°
# ==============================================================================

def evaluate_judge_prompt(judge_prompt, dataset):
    """
    è¯„ä¼°è£åˆ¤æç¤ºè¯åœ¨æ•°æ®é›†ä¸Šçš„å‡†ç¡®ç‡ã€‚
    
    ã€æ ¸å¿ƒæœºåˆ¶ã€‘
    1. éå†æ•°æ®é›†ï¼Œä½¿ç”¨è£åˆ¤æç¤ºè¯å¯¹æ¯ä¸ªæ ·æœ¬è¿›è¡Œåˆ¤æ–­
    2. å¯¹æ¯”é¢„æµ‹ç»“æœä¸çœŸå®æ ‡ç­¾ï¼Œè®¡ç®—å‡†ç¡®ç‡
    3. è®°å½•æ‰€æœ‰é”™åˆ¤çš„æ¡ˆä¾‹ï¼ˆç”¨äºåç»­ä¼˜åŒ–ï¼‰
    
    Args:
        judge_prompt: è£åˆ¤æç¤ºè¯æ¨¡æ¿ï¼ˆåŒ…å« {response_to_judge} å ä½ç¬¦ï¼‰
        dataset: æ ‡æ³¨æ•°æ®é›†ï¼ˆlist of dictï¼‰
        
    Returns:
        tuple: (å‡†ç¡®ç‡, é”™åˆ¤æ¡ˆä¾‹åˆ—è¡¨)
    """
    correct_predictions = 0
    misjudged_cases = []
    
    for sample in dataset:
        # å¡«å……å¾…è¯„ä¼°çš„å›ç­”
        prompt = judge_prompt.format(response_to_judge=sample["response"])
        
        # çœŸå®è°ƒç”¨ LLM
        predicted_label = llm.invoke(prompt)
        
        # åˆ¤æ–­æ˜¯å¦æ­£ç¡®
        is_correct = (predicted_label.strip() == sample["label"])
        if is_correct:
            correct_predictions += 1
        else:
            misjudged_cases.append({
                "id": sample.get("id", "unknown"),
                "response": sample["response"],
                "current_judgment": predicted_label.strip(),
                "correct_judgment": sample["label"],
                "reason": sample.get("reason", "")
            })
            
    accuracy = correct_predictions / len(dataset) if len(dataset) > 0 else 0
    return accuracy, misjudged_cases


# ==============================================================================
# é˜¶æ®µ 1: è®­ç»ƒè£åˆ¤ (Train the Judge)
# ==============================================================================

def demo_train_judge():
    """
    æ¼”ç¤ºå¦‚ä½•é€šè¿‡æ ‡æ³¨æ•°æ®è®­ç»ƒä¸€ä¸ªå¯é çš„ AI è£åˆ¤ã€‚
    
    ã€æ ¸å¿ƒæ€æƒ³ã€‘
    å°±åƒè®­ç»ƒä¸€ä¸ªäººç±»è¯„å®¡ä¸€æ ·ï¼Œé€šè¿‡"é”™é¢˜é›†"ä¸æ–­æ”¹è¿›è£åˆ¤çš„è¯„åˆ¤æ ‡å‡†ã€‚
    
    ã€è®­ç»ƒæµç¨‹ã€‘
    1. åˆå§‹åŒ–ï¼šåˆ›å»ºä¸€ä¸ªç®€å•çš„è£åˆ¤æç¤ºè¯
    2. è¯„ä¼°ï¼šåœ¨è®­ç»ƒé›†ä¸Šæµ‹è¯•ï¼Œæ‰¾å‡ºé”™åˆ¤çš„æ¡ˆä¾‹
    3. ä¼˜åŒ–ï¼šé’ˆå¯¹é”™åˆ¤æ¡ˆä¾‹ï¼Œè®© LLM ä¼˜åŒ–è£åˆ¤æç¤ºè¯
    4. è¿­ä»£ï¼šé‡å¤ 2-3 ç›´åˆ°è®­ç»ƒé›†å‡†ç¡®ç‡è¾¾æ ‡
    
    ã€ç»ˆæ­¢æ¡ä»¶ã€‘
    - è®­ç»ƒé›†ä¸Šæ— é”™åˆ¤ï¼ˆå‡†ç¡®ç‡ 100%ï¼‰
    - è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°
    
    ã€å…³é”®åˆ›æ–°ã€‘
    ä¼ ç»Ÿæ–¹æ³•æ˜¯äººå·¥ç¼–å†™è¯„åˆ¤æ ‡å‡†ï¼Œè¿™é‡Œæ˜¯è®© AI é€šè¿‡"é”™é¢˜"è‡ªåŠ¨å­¦ä¹ æ ‡å‡†ã€‚
    
    Returns:
        str: è®­ç»ƒå¥½çš„è£åˆ¤æç¤ºè¯
    """
    print("\n" + "="*60)
    print("  é˜¶æ®µ 1: è®­ç»ƒè£åˆ¤ (Train the Judge)")
    print("="*60)
    
    # æŒ‰æ¯”ä¾‹æ‹†åˆ†æ•°æ®é›†
    train_set = LABELED_SAMPLES[:3]  # å‰3ä¸ªç”¨äºè®­ç»ƒ
    eval_set = LABELED_SAMPLES[3:]   # å2ä¸ªç”¨äºè¯„ä¼°
    
    # å‡†å¤‡åˆå§‹ç‰ˆçš„"è£åˆ¤æç¤ºè¯" (v1.0)
    judge_prompt_v1 = """
# v1
ã€è§’è‰²ã€‘ä½ æ˜¯ä¸€ä½å‘˜å·¥ä½“éªŒä¸“å®¶ã€‚
ã€ä»»åŠ¡ã€‘åˆ¤æ–­ã€å¾…è¯„ä¼°çš„å›ç­”ã€‘æ˜¯å¦åˆæ ¼ã€‚
ã€è¯„åˆ¤æ ‡å‡†ã€‘
1. ç»“æ„æ¸…æ™°: ä¿¡æ¯åˆ†ç‚¹æˆ–åˆ†ç±»åˆ—å‡ºã€‚
2. ä¿¡æ¯å®Œæ•´: æåŠæ ¸å¿ƒç¦åˆ©ã€‚
ã€å¾…è¯„ä¼°çš„å›ç­”ã€‘
---
{response_to_judge}
---
ã€è¾“å‡ºè¦æ±‚ã€‘è¯·åªå›ç­”"é€šè¿‡"æˆ–"ä¸é€šè¿‡"ã€‚
"""

    current_judge_prompt = judge_prompt_v1
    max_iterations = 3
    
    print(f"\nğŸ“‹ è®­ç»ƒé›†æ ·æœ¬æ•°: {len(train_set)}")
    print(f"\nğŸ“‹ è¯„ä¼°é›†æ ·æœ¬æ•°: {len(eval_set)}")
    print(f"\nğŸ¯ è®­ç»ƒç›®æ ‡: åœ¨è®­ç»ƒé›†ä¸Šè¾¾åˆ° 100% å‡†ç¡®ç‡\n")

    for i in range(max_iterations):
        print(f"\n{'â”€'*60}")
        print(f"  ç¬¬ {i+1} è½®è¿­ä»£")
        print(f"{'â”€'*60}")
    
        # åœ¨è®­ç»ƒé›†å’Œè¯„ä¼°é›†ä¸Šè¯„ä¼°
        train_accuracy, misjudged_on_train = evaluate_judge_prompt(
            current_judge_prompt, train_set
        )
        eval_accuracy, _ = evaluate_judge_prompt(
            current_judge_prompt, eval_set
        )
    
        print(f"\nğŸ“Š è®­ç»ƒé›†å‡†ç¡®ç‡: {train_accuracy:.0%} ({int(train_accuracy * len(train_set))}/{len(train_set)})")
        print(f"ğŸ“Š è¯„ä¼°é›†å‡†ç¡®ç‡: {eval_accuracy:.0%} ({int(eval_accuracy * len(eval_set))}/{len(eval_set)})")

        # å¦‚æœè®­ç»ƒé›†ä¸Šå·²ç»æ²¡æœ‰é”™è¯¯ï¼Œè®­ç»ƒå®Œæˆ
        if not misjudged_on_train:
            print("\nâœ… è®­ç»ƒé›†ä¸Šå·²æ— é”™è¯¯ï¼Œè£åˆ¤è®­ç»ƒå®Œæˆï¼")
            break
        
        # æ‰¾å‡ºç¬¬ä¸€ä¸ªé”™åˆ¤æ¡ˆä¾‹
        first_error = misjudged_on_train[0]
        print(f"\nâŒ å‘ç°é”™åˆ¤:")
        print(f"   æ ·æœ¬ ID: {first_error['id']}")
        print(f"   é”™è¯¯åˆ¤æ–­: {first_error['current_judgment']}")
        print(f"   æ­£ç¡®åˆ¤æ–­: {first_error['correct_judgment']}")
        print(f"   é”™è¯¯åŸå› : {first_error['reason']}")

        # è®©å¤§æ¨¡å‹æ ¹æ®é”™é¢˜ä¼˜åŒ–è£åˆ¤æç¤ºè¯
        print("\nğŸ”§ æ ¹æ®é”™é¢˜ä¼˜åŒ–è£åˆ¤æç¤ºè¯...")
        
        judge_optimizer_prompt = f"""
ã€è§’è‰²ã€‘ä½ æ˜¯ä¸€ä½é¡¶çº§çš„æç¤ºè¯å·¥ç¨‹å¸ˆã€‚
ã€èƒŒæ™¯ã€‘æˆ‘å½“å‰çš„è£åˆ¤æç¤ºè¯åœ¨è¯„ä¼°ä¸€ä¸ªæ ·æœ¬æ—¶çŠ¯äº†é”™è¯¯ã€‚

ã€æˆ‘å½“å‰çš„è£åˆ¤æç¤ºè¯ã€‘
---
{current_judge_prompt}
---

ã€å‘ç”Ÿé”™è¯¯çš„æ¡ˆä¾‹ã€‘
- å¾…è¯„ä¼°çš„å›ç­”: "{first_error['response']}"
- æˆ‘çš„å·¥å…·çš„é”™è¯¯åˆ¤æ–­: "{first_error['current_judgment']}"
- æˆ‘æœŸæœ›çš„æ­£ç¡®åˆ¤æ–­: "{first_error['correct_judgment']}"
- é”™è¯¯çš„æ ¹æœ¬åŸå› : {first_error['reason']}

ã€ä»»åŠ¡ã€‘è¯·é‡å†™æˆ‘çš„è£åˆ¤æç¤ºè¯ï¼Œä½¿å…¶è¯„åˆ¤æ ‡å‡†æ›´ä¸¥æ ¼ã€æ›´å‡†ç¡®ï¼Œèƒ½ä¿®æ­£ä¸Šè¿°é”™è¯¯ã€‚

ã€è¦æ±‚ã€‘è¯·åªè¿”å›ä¼˜åŒ–åçš„æ–°æç¤ºè¯ï¼Œä¸è¦åŒ…å«ä»»ä½•è§£é‡Šã€‚
"""
    
        new_judge_prompt = llm.invoke(judge_optimizer_prompt)
        
        print("\nğŸ“ ä¼˜åŒ–åçš„è£åˆ¤æç¤ºè¯ï¼ˆå‰ 100 å­—ç¬¦ï¼‰:")
        print(f"{new_judge_prompt[:100]}...")
    
        current_judge_prompt = new_judge_prompt
    else:
        print("\nâš ï¸ è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œåœæ­¢è®­ç»ƒã€‚")

    print("\n" + "="*60)
    print("  è£åˆ¤è®­ç»ƒå®Œæˆ")
    print("="*60)
    
    return current_judge_prompt


# ==============================================================================
# é˜¶æ®µ 2: è£åˆ¤é©±åŠ¨çš„ç”Ÿæˆå™¨ä¼˜åŒ–
# ==============================================================================

def optimize_with_judge_rules(current_prompt, failed_response, judge_prompt):
    """
    åŸºäºè£åˆ¤è§„åˆ™ä¼˜åŒ–ç”Ÿæˆæç¤ºè¯ã€‚
    
    ã€æ ¸å¿ƒæ€æƒ³ã€‘
    ä¸æ˜¯ç›²ç›®ä¼˜åŒ–ï¼Œè€Œæ˜¯è®©ä¼˜åŒ–å™¨"é˜…è¯»è£åˆ¤è§„åˆ™ä¹¦"ï¼Œæœ‰é’ˆå¯¹æ€§åœ°æ”¹è¿›ã€‚
    
    ã€å…³é”®åŒºåˆ«ã€‘
    - ä¼ ç»Ÿæ–¹æ³•ï¼šæ ¹æ®å·®è·åˆ†ææŠ¥å‘Šä¼˜åŒ–ï¼ˆä¸»è§‚ï¼‰
    - æœ¬æ–¹æ³•ï¼šæ ¹æ®è£åˆ¤çš„æ˜ç¡®è§„åˆ™ä¼˜åŒ–ï¼ˆå®¢è§‚ï¼‰
    
    Args:
        current_prompt: å½“å‰çš„ç”Ÿæˆæç¤ºè¯
        failed_response: æœªé€šè¿‡å®¡æ ¸çš„å›ç­”
        judge_prompt: è£åˆ¤çš„æç¤ºè¯ï¼ˆåŒ…å«è¯„åˆ¤æ ‡å‡†ï¼‰
        
    Returns:
        str: ä¼˜åŒ–åçš„ç”Ÿæˆæç¤ºè¯
    """
    optimizer_prompt = f"""
    ã€è§’è‰²ã€‘ä½ æ˜¯ä¸€ä½é¡¶çº§çš„æç¤ºè¯å·¥ç¨‹å¸ˆã€‚
ã€èƒŒæ™¯ã€‘æˆ‘æœ‰ä¸€ä¸ª"ç”Ÿæˆæç¤ºè¯"ï¼Œä½†å®ƒç”Ÿæˆçš„å›ç­”æœªèƒ½é€šè¿‡"AIè£åˆ¤"çš„å®¡æ ¸ã€‚
    
    ã€ç”Ÿæˆæç¤ºè¯ã€‘
    ---
    {current_prompt}
    ---
    
    ã€å®ƒç”Ÿæˆçš„å¤±è´¥å›ç­”ã€‘
    ---
    {failed_response}
    ---
    
    ã€AIè£åˆ¤çš„è§„åˆ™ä¹¦ (å®ƒå¤±è´¥çš„åŸå› )ã€‘
    ---
    {judge_prompt}
    ---
    
    ã€ä»»åŠ¡ã€‘
è¯·ä»”ç»†ç ”ç©¶"AIè£åˆ¤çš„è§„åˆ™ä¹¦"ï¼Œå¹¶é‡å†™"ç”Ÿæˆæç¤ºè¯"ï¼Œç¡®ä¿æ–°æç¤ºè¯èƒ½ç”Ÿæˆä¸€ä¸ªå¯ä»¥é€šè¿‡è¯¥è§„åˆ™å®¡æ ¸çš„å›ç­”ã€‚
    
    ã€è¦æ±‚ã€‘
è¯·åªè¿”å›ä¼˜åŒ–åçš„æ–°ç‰ˆ"ç”Ÿæˆæç¤ºè¯"ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–è¯´æ˜æˆ–è§£é‡Šã€‚
    """
    new_prompt = llm.invoke(optimizer_prompt)
    return new_prompt


def demo_judge_driven_optimization(trained_judge_prompt):
    """
    æ¼”ç¤ºä½¿ç”¨è®­ç»ƒå¥½çš„è£åˆ¤é©±åŠ¨ç”Ÿæˆå™¨ä¼˜åŒ–ã€‚
    
    ã€æ ¸å¿ƒæ€æƒ³ã€‘
    è£åˆ¤å°±åƒä¸€ä¸ªä¸¥æ ¼çš„è¯„å®¡ä¸“å®¶ï¼Œç”Ÿæˆå™¨å¿…é¡»ä¸æ–­æ”¹è¿›ç›´åˆ°é€šè¿‡å®¡æ ¸ã€‚
    
    ã€ä¼˜åŒ–æµç¨‹ã€‘
    1. ç”Ÿæˆå™¨ç”Ÿæˆå›ç­”
    2. è£åˆ¤è¿›è¡Œå®¡æ ¸ï¼ˆé€šè¿‡/ä¸é€šè¿‡ï¼‰
    3. å¦‚æœä¸é€šè¿‡ï¼Œä¼˜åŒ–å™¨å‚è€ƒè£åˆ¤è§„åˆ™æ”¹è¿›ç”Ÿæˆæç¤ºè¯
    4. è¿­ä»£ç›´åˆ°é€šè¿‡å®¡æ ¸
    
    ã€å…³é”®ä¼˜åŠ¿ã€‘
    - æ˜ç¡®çš„é€šè¿‡æ ‡å‡†ï¼ˆè£åˆ¤è§„åˆ™ï¼‰
    - è‡ªåŠ¨åŒ–çš„ä¼˜åŒ–é—­ç¯
    - å¯é‡åŒ–çš„è¿›å±•ï¼ˆé€šè¿‡/ä¸é€šè¿‡ï¼‰
    
    Args:
        trained_judge_prompt: è®­ç»ƒå¥½çš„è£åˆ¤æç¤ºè¯
    """
    print("\n" + "="*60)
    print("  é˜¶æ®µ 2: è£åˆ¤é©±åŠ¨çš„ç”Ÿæˆå™¨ä¼˜åŒ–")
    print("="*60)
    
    # åˆå§‹çš„ç”Ÿæˆæç¤ºè¯ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
    initial_prompt = """
æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ï¼Œå›ç­”æ–°å‘˜å·¥å…³äºå…¬å¸ç¦åˆ©çš„é—®é¢˜ã€‚

ã€å‚è€ƒä¿¡æ¯ã€‘
{retrieved_text}
"""
    
    current_generating_prompt = initial_prompt
    max_iterations = 5

    print(f"\nğŸ¯ ä¼˜åŒ–ç›®æ ‡: ç”Ÿæˆèƒ½é€šè¿‡è£åˆ¤å®¡æ ¸çš„å›ç­”")
    print(f"ğŸ¯ æœ€å¤§è¿­ä»£æ¬¡æ•°: {max_iterations}\n")

    for i in range(max_iterations):
        print(f"\n{'â”€'*60}")
        print(f"  ç¬¬ {i+1} è½®è¿­ä»£")
        print(f"{'â”€'*60}")
    
        # 1. ç”Ÿæˆå›ç­”
        print("\nğŸ¤– ç”Ÿæˆå›ç­”ä¸­...")
        prompt_for_generator = current_generating_prompt.format(retrieved_text=RETRIEVED_TEXT)
        generated_response = llm.invoke(prompt_for_generator)
    
        print(f"\nç”Ÿæˆçš„å›ç­”ï¼ˆå‰ 200 å­—ç¬¦ï¼‰:")
        print(f"{generated_response[:200]}...")
    
        # 2. è°ƒç”¨è£åˆ¤è¿›è¡Œå®¡æ ¸
        print("\nâš–ï¸ è£åˆ¤å®¡æ ¸ä¸­...")
        judge_prompt_filled = trained_judge_prompt.format(response_to_judge=generated_response)
        judgment = llm.invoke(judge_prompt_filled)
    
        # æ¸…ç†åˆ¤å†³ç»“æœ
        judgment_cleaned = judgment.strip().replace("ã€‚", "").replace("!", "").replace("ï¼", "")
        print(f"è£åˆ¤åˆ¤å†³: {judgment_cleaned}")

        # 3. å†³ç­–
        if judgment_cleaned == "é€šè¿‡":
            print("\nâœ… ä¼˜åŒ–æˆåŠŸï¼ç”Ÿæˆçš„å›ç­”å·²é€šè¿‡è£åˆ¤å®¡æ ¸ã€‚")
            break
        else:
            print("\nâŒ æœªé€šè¿‡å®¡æ ¸ï¼Œæ ¹æ®è£åˆ¤è§„åˆ™è¿›è¡Œä¼˜åŒ–...")
            current_generating_prompt = optimize_with_judge_rules(
                current_generating_prompt, 
                generated_response, 
                trained_judge_prompt
            )
            print(f"ä¼˜åŒ–åçš„ç”Ÿæˆæç¤ºè¯ï¼ˆå‰ 100 å­—ç¬¦ï¼‰:\n{current_generating_prompt[:100]}...")
    else:
        print("\nâš ï¸ è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œåœæ­¢ä¼˜åŒ–ã€‚")

    print("\n" + "="*60)
    print("  ç”Ÿæˆå™¨ä¼˜åŒ–å®Œæˆ")
    print("="*60)
    
    print("\nğŸ“ æœ€ç»ˆé‡‡çº³çš„ç”Ÿæˆæç¤ºè¯:")
    print("-"*60)
    print(current_generating_prompt)
    print("-"*60)
    
    return current_generating_prompt


# ==============================================================================
# ä¸»ç¨‹åºå…¥å£
# ==============================================================================

def main():
    """ä¸»ç¨‹åºï¼šæ‰§è¡Œ Meta Prompting è¿›é˜¶å®éªŒ"""
    
    print("\n" + "="*60)
    print("  Meta Prompting è¿›é˜¶å®éªŒ")
    print("  åŸºäº AI åˆ¤åˆ«å™¨çš„è‡ªåŠ¨åŒ–ä¼˜åŒ–")
    print("="*60)
    
    # åŠ è½½ API Key
    load_key()
    
    try:
        # é˜¶æ®µ 1ï¼šè®­ç»ƒè£åˆ¤
        trained_judge_prompt = demo_train_judge()
        
        # é˜¶æ®µ 2ï¼šä½¿ç”¨è®­ç»ƒå¥½çš„è£åˆ¤ä¼˜åŒ–ç”Ÿæˆå™¨
        demo_judge_driven_optimization(trained_judge_prompt)
        
    except Exception as e:
        print(f"\nâŒ è¿è¡Œå‡ºé”™: {e}")
        import traceback
        traceback.print_exc()
    
    print("\n" + "="*60)
    print("  æ‰€æœ‰å®éªŒå®Œæˆï¼")
    print("="*60)
    print("\nã€æ€»ç»“ã€‘")
    print("Meta Prompting è¿›é˜¶ç‰ˆæœ¬é€šè¿‡å¼•å…¥æ•°æ®é©±åŠ¨çš„è£åˆ¤è®­ç»ƒï¼Œ")
    print("æ˜¾è‘—æå‡äº†ä¼˜åŒ–è¿‡ç¨‹çš„å¯æ§æ€§å’Œå¯é‡ç°æ€§ã€‚")
    print("\nã€å…³é”®æ”¹è¿›ã€‘")
    print("  âœ“ å®¢è§‚æ ‡å‡†ï¼šåŸºäºæ ‡æ³¨æ•°æ®ï¼Œè€Œéä¸»è§‚åˆ¤æ–­")
    print("  âœ“ å¯é‡åŒ–ï¼šå‡†ç¡®ç‡ä½œä¸ºæ˜ç¡®æŒ‡æ ‡")
    print("  âœ“ å¯è¿­ä»£ï¼šè‡ªåŠ¨åŒ–çš„ä¼˜åŒ–é—­ç¯")
    print("  âœ“ æ›´æ¥è¿‘ç”Ÿäº§çº§ï¼šDSPy å·¥ç¨‹åŒ–æ€æƒ³")
    print("\nã€ä¸‹ä¸€æ­¥ã€‘")
    print("  â†’ æ‰©å±•æ ‡æ³¨æ•°æ®é›†ï¼Œæå‡è£åˆ¤æ³›åŒ–èƒ½åŠ›")
    print("  â†’ å¼•å…¥å¤šè£åˆ¤æŠ•ç¥¨æœºåˆ¶ï¼Œæå‡ç¨³å®šæ€§")
    print("  â†’ é›†æˆåˆ° CI/CD æµæ°´çº¿ï¼ŒæŒç»­ä¼˜åŒ–\n")


if __name__ == "__main__":
    main()
